<!-- 
RSS generated by JIRA (9.12.27#9120027-sha1:edc4490121e366e9e7bd2213d532dbe7e028fc5d) at Sat Sep 27 10:04:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>Java Bug System</title>
    <link>https://bugs.openjdk.org</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-us</language>    <build-info>
        <version>9.12.27</version>
        <build-number>9120027</build-number>
        <build-date>02-09-2025</build-date>
    </build-info>


<item>
            <title>[JDK-8347129] cpuset cgroups controller is required for no good reason</title>
                <link>https://bugs.openjdk.org/browse/JDK-8347129</link>
                <project id="10100" key="JDK">JDK</project>
                    <description>The OpenJDK hotspot container detection code assumes the following cgroup controllers as required: cpu, cpuset, cpuacct, memory. If one of those controllers are not available, or not enabled at the kernel level, the container detection code fails and falls back to host-only resource limits.&lt;br/&gt;
&lt;br/&gt;
This is problematic on some systems, like Fedora 41, which don&amp;#39;t have the cpuset controller enabled by default any more. File /proc/cgroups file doesn&amp;#39;t list the controller as enabled. Example:&lt;br/&gt;
&lt;br/&gt;
$ cat /proc/cgroups &lt;br/&gt;
#subsys_name	hierarchy	num_cgroups	enabled&lt;br/&gt;
cpu	0	357	1&lt;br/&gt;
cpuacct	0	357	1&lt;br/&gt;
blkio	0	357	1&lt;br/&gt;
memory	0	357	1&lt;br/&gt;
devices	0	357	1&lt;br/&gt;
freezer	0	357	1&lt;br/&gt;
net_cls	0	357	1&lt;br/&gt;
perf_event	0	357	1&lt;br/&gt;
net_prio	0	357	1&lt;br/&gt;
hugetlb	0	357	1&lt;br/&gt;
pids	0	357	1&lt;br/&gt;
rdma	0	357	1&lt;br/&gt;
misc	0	357	1&lt;br/&gt;
&lt;br/&gt;
I.e. there is no cpuset controller. This results in this output when container detection tracing is turned on:&lt;br/&gt;
&lt;br/&gt;
$ ./bin/java -Xlog:os+container=trace --version&lt;br/&gt;
[0.000s][trace][os,container] OSContainer::init: Initializing Container Support&lt;br/&gt;
[0.000s][debug][os,container] Detected optional pids controller entry in /proc/cgroups&lt;br/&gt;
[0.000s][debug][os,container] controller cpu is not enabled&lt;br/&gt;
[                           ] &lt;br/&gt;
[0.000s][debug][os,container] One or more required controllers disabled at kernel level.&lt;br/&gt;
openjdk 25-internal 2025-09-16&lt;br/&gt;
OpenJDK Runtime Environment (build 25-internal-adhoc.sgehwolf.jdk-jdk)&lt;br/&gt;
OpenJDK 64-Bit Server VM (build 25-internal-adhoc.sgehwolf.jdk-jdk, mixed mode, sharing)&lt;br/&gt;
&lt;br/&gt;
There is a secondary bug which incorrectly maps the &amp;#39;cpuset&amp;#39; controller to the &amp;#39;cpu&amp;#39; one in the log output. Fixing that bug results in:&lt;br/&gt;
&lt;br/&gt;
$ ./bin/java -Xlog:os+container=trace --version&lt;br/&gt;
[0.001s][trace][os,container] OSContainer::init: Initializing Container Support&lt;br/&gt;
[0.001s][debug][os,container] Detected optional pids controller entry in /proc/cgroups&lt;br/&gt;
[0.001s][debug][os,container] controller cpuset is not enabled&lt;br/&gt;
[                           ] &lt;br/&gt;
[0.001s][debug][os,container] One or more required controllers disabled at kernel level.&lt;br/&gt;
openjdk 25-internal 2025-09-16&lt;br/&gt;
OpenJDK Runtime Environment (build 25-internal-adhoc.sgehwolf.jdk-jdk)&lt;br/&gt;
OpenJDK 64-Bit Server VM (build 25-internal-adhoc.sgehwolf.jdk-jdk, mixed mode, sharing)&lt;br/&gt;
&lt;br/&gt;
With all that said, the cpuset controller isn&amp;#39;t really that essential. os::Linux::active_processor_count() uses sched_getaffinity() which in-turn figures out the cpuset setting. Thus, it&amp;#39;s only reporting code that actually uses the cpuset controller interface files. This suggests that this controller can be made optional and improve automatic detection code on more systems.</description>
                <environment></environment>
        <key id="5147372">JDK-8347129</key>
            <summary>cpuset cgroups controller is required for no good reason</summary>
                <type id="1" iconUrl="https://bugs.openjdk.org/secure/viewavatar?size=xsmall&amp;avatarId=14703&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://bugs.openjdk.org/images/jbsImages/p3.png">P3</priority>
                        <status id="5" iconUrl="https://bugs.openjdk.org/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="success"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sgehwolf">Severin Gehwolf</assignee>
                                    <reporter username="sgehwolf">Severin Gehwolf</reporter>
                        <labels>
                            <label>containers</label>
                            <label>jdk21u-fix-request</label>
                            <label>jdk21u-fix-yes</label>
                            <label>jdk24u-fix-SQE-ok</label>
                            <label>jdk24u-fix-request</label>
                            <label>jdk24u-fix-yes</label>
                    </labels>
                <created>Tue, 7 Jan 2025 08:52:30 -0800</created>
                <updated>Wed, 4 Jun 2025 16:24:12 -0700</updated>
                            <resolved>Tue, 14 Jan 2025 11:45:18 -0800</resolved>
                                    <version>openjdk8u432</version>
                    <version>11.0.25</version>
                    <version>17</version>
                    <version>21</version>
                    <version>24</version>
                    <version>25</version>
                                    <fixVersion>25</fixVersion>
                                    <component>hotspot</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14744920" author="sgehwolf" created="Tue, 28 Jan 2025 10:57:46 -0800"  >Fix Request (OpenJDK 21u):&lt;br/&gt;
Please approve this clean backport to JDK 21. This issue breaks physical memory detection heuristics when run in containers on affected systems (Kernel 6.12 and newer). Risk should be low as cpuset quotas are handled by sched_getaffinity() calls used in os::Linux::active_processor_count(). Container tests in test/hotspot/jtreg/containers pass on an affected system (failed before). Also tested on cgroups v1.</comment>
                            <comment id="14744909" author="roboduke" created="Tue, 28 Jan 2025 09:57:28 -0800"  >A pull request was submitted for review.&lt;br/&gt;
Branch: master&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk21u-dev/pull/1366&quot;&gt;https://git.openjdk.org/jdk21u-dev/pull/1366&lt;/a&gt;&lt;br/&gt;
Date: 2025-01-28 17:51:09 +0000</comment>
                            <comment id="14741380" author="sgehwolf" created="Tue, 21 Jan 2025 07:37:22 -0800"  >Fix Request (OpenJDK 24u):&lt;br/&gt;
Please approve this clean backport to JDK 24. It&amp;#39;s affected as well and the fix is fairly low-risk and isolated. Container tests on patched JDK 24 pass on an affected system. Risk should be low as sched_getaffinity() would handle cpuset quotas.</comment>
                            <comment id="14741308" author="roboduke" created="Tue, 21 Jan 2025 04:20:47 -0800"  >A pull request was submitted for review.&lt;br/&gt;
Branch: master&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk24u/pull/24&quot;&gt;https://git.openjdk.org/jdk24u/pull/24&lt;/a&gt;&lt;br/&gt;
Date: 2025-01-21 12:13:00 +0000</comment>
                            <comment id="14738703" author="dukebot" created="Tue, 14 Jan 2025 11:45:17 -0800"  >Changeset: 2de71d04&lt;br/&gt;
Branch: master&lt;br/&gt;
Author:    Severin Gehwolf &amp;lt;&lt;a href=&apos;mailto:sgehwolf@openjdk.org&apos;&gt;sgehwolf@openjdk.org&lt;/a&gt;&amp;gt;&lt;br/&gt;
Date:      2025-01-14 19:40:50 +0000&lt;br/&gt;
URL:       &lt;a href=&quot;https://git.openjdk.org/jdk/commit/2de71d04454b04ee887f7bd3e5decbfaa9ab8460&quot;&gt;https://git.openjdk.org/jdk/commit/2de71d04454b04ee887f7bd3e5decbfaa9ab8460&lt;/a&gt;&lt;br/&gt;
</comment>
                            <comment id="14738702" author="sgehwolf" created="Tue, 14 Jan 2025 11:45:14 -0800"  >This change only fixes it for cgroups v2 since cgroups v1 is legacy and it not a good idea to change this old code at this point. It&amp;#39;s highly unlikely that cg v1 is enabled on very new kernels. RHEL 9 has cgroups v2 by default. Newer systems like fedora 41 don&amp;#39;t allow cg v1 anymore.</comment>
                            <comment id="14737346" author="roboduke" created="Fri, 10 Jan 2025 06:21:23 -0800"  >A pull request was submitted for review.&lt;br/&gt;
Branch: master&lt;br/&gt;
URL: &lt;a href=&quot;https://git.openjdk.org/jdk/pull/23037&quot;&gt;https://git.openjdk.org/jdk/pull/23037&lt;/a&gt;&lt;br/&gt;
Date: 2025-01-10 14:14:59 +0000</comment>
                            <comment id="14737324" author="sgehwolf" created="Fri, 10 Jan 2025 05:08:53 -0800"  >Due to this issue a couple of container tests fail (on affected systems):&lt;br/&gt;
&lt;br/&gt;
Passed: containers/cgroup/CgroupSubsystemFactory.java&lt;br/&gt;
Passed: containers/cgroup/TestContainerized.java&lt;br/&gt;
Passed: containers/docker/DockerBasicTest.java&lt;br/&gt;
Passed: containers/docker/ShareTmpDir.java&lt;br/&gt;
Passed: containers/docker/TestContainerInfo.java&lt;br/&gt;
FAILED: containers/docker/TestCPUAwareness.java&lt;br/&gt;
FAILED: containers/docker/TestCPUSets.java&lt;br/&gt;
Passed: containers/docker/TestJcmd.java&lt;br/&gt;
Passed: containers/docker/TestJcmdWithSideCar.java&lt;br/&gt;
FAILED: containers/docker/TestJFREvents.java&lt;br/&gt;
Passed: containers/docker/TestJFRNetworkEvents.java&lt;br/&gt;
Passed: containers/docker/TestJFRWithJMX.java&lt;br/&gt;
FAILED: containers/docker/TestLimitsUpdating.java&lt;br/&gt;
FAILED: containers/docker/TestMemoryAwareness.java&lt;br/&gt;
Passed: containers/docker/TestMemoryWithCgroupV1.java&lt;br/&gt;
FAILED: containers/docker/TestMisc.java&lt;br/&gt;
FAILED: containers/docker/TestPids.java&lt;br/&gt;
FAILED: containers/systemd/SystemdMemoryAwarenessTest.java</comment>
                            <comment id="14736299" author="sgehwolf" created="Tue, 7 Jan 2025 09:32:56 -0800"  >Patch for secondary bug:&lt;br/&gt;
&lt;br/&gt;
diff --git a/src/hotspot/os/linux/cgroupSubsystem_linux.cpp b/src/hotspot/os/linux/cgroupSubsystem_linux.cpp&lt;br/&gt;
index 4a8fda432d8..0791f7fed3f 100644&lt;br/&gt;
--- a/src/hotspot/os/linux/cgroupSubsystem_linux.cpp&lt;br/&gt;
+++ b/src/hotspot/os/linux/cgroupSubsystem_linux.cpp&lt;br/&gt;
@@ -37,7 +37,7 @@&lt;br/&gt;
&amp;nbsp;#include &amp;quot;utilities/globalDefinitions.hpp&amp;quot;&lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
&amp;nbsp;// controller names have to match the *_IDX indices&lt;br/&gt;
-static const char* cg_controller_name[] = { &amp;quot;cpu&amp;quot;, &amp;quot;cpuset&amp;quot;, &amp;quot;cpuacct&amp;quot;, &amp;quot;memory&amp;quot;, &amp;quot;pids&amp;quot; };&lt;br/&gt;
+static const char* cg_controller_name[] = { &amp;quot;cpuset&amp;quot;, &amp;quot;cpu&amp;quot;, &amp;quot;cpuacct&amp;quot;, &amp;quot;memory&amp;quot;, &amp;quot;pids&amp;quot; };&lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
&amp;nbsp;CgroupSubsystem* CgroupSubsystemFactory::create() {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;CgroupV1MemoryController* memory = nullptr;&lt;br/&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10200">
                    <name>Backport</name>
                                            <outwardlinks description="backported by">
                                        <issuelink>
            <issuekey id="5149173">JDK-8348691</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5149432">JDK-8348942</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="5160622">JDK-8358629</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10002">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="5147013">JDK-8346874</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10003">
                    <name>Relates</name>
                                                                <inwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="5148844">JDK-8349527</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_10000" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>CPU</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17008"><![CDATA[generic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11700" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10600" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-fixedBackportedCustomfield">
                        <customfieldname>Fixed</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_10005" key="com.atlassian.jira.plugin.system.customfieldtypes:multiselect">
                        <customfieldname>OS</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17023"><![CDATA[linux]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_11100" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i39a6r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_11004" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10006" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Resolved In Build</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="17334"><![CDATA[b06]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_10008" key="com.oracle.jira.jira-subcomponent-plugin:oracle-subComponentField">
                        <customfieldname>Subcomponent</customfieldname>
                        <customfieldvalues>
                             <customfieldvalue key="192"><![CDATA[runtime]]></customfieldvalue> 
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_10601" key="com.oracle.jira.javabugsystem-jira-plugin:jbs-targetBackportedCustomfield">
                        <customfieldname>Targeted</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>